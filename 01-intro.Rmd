
# Графичен метод

```{r}
# install.packages("matlib")
library(tidyverse)
library(matlib)
# options(scipen=999)
```


## Планиране на производство

Бутиково кафене в София предлага два продукта: Супер еспресо и Делукс еспресо. За 
приготвянето на един килограм от първия вид кафе са необходими по равни части 
бразилско и кубинско кафе, а рецептата за Делукс предвижда смес от бразилско и 
кубинско кафе в пропорция 1 към 3. Доставчиците са готови да осигурят 120 кг
бразилско и 160 кг. кубинско кафе. Заведението знае, че няма да може да продаде
повече от 150 кг. Делукс еспресо. От всеки продаден килограм Супер еспресо 
заведението печели 40 лв., докато печалбата от килограм Делукс възлиза на 
50 лв.

Колко от двата типа кафе ще препоръчате на кафенето да смеси?

### Математически модел

променливи?

$$
x_1: \text{ Супер еспресо (кг.)}\\
x_2: \text{ Делукс еспресо (кг.)}
$$

$$
\max z = 40 x_1 + 50 x_2 \text{ (целева функция)} \\
0.5 x_1 + 0.25 x_2 \leq 120 \text{ (бразилско кафе)}\\
0.5 x_1 + 0.75 x_2 \leq 160 \text{ (кубинско кафе)} \\
0 \cdot x_1 + x_2 \leq 150 \text{ (търсене делукс)}\\
x_1 \geq 0 \\
x_2 \geq 0
$$

### Допустимо множество

Както и в предишната задаче ще изобразим графично допустимото множество, като начертаем правите, към всяко от петте неравенства:

$$
\begin{align}
    0.5 x_1 + 0.25 x_2 & = 120 \\
    0.5 x_1 + 0.75 x_2 & = 160 \\
    0 \cdot x_1 + x_2 & = 150
\end{align}
$$


Първо ще пресметнем пресечните точки на трите прави с осите $x_1$ и  $x_2$?

- Права бразилско кафе: 
  (0, 120 / 0.25 = 480), (120 / 0.5 = 240, 0)
- Права кубинско кафе: 
  (0, 160 / 0.75), (160 / 0.5, 0)
- Права търсене на Делукс:
  (0, 150), (100, 150)
  Тази права е успоредна на оста $x_1$.

```{r feasible-set-lines, echo = FALSE, fig.cap="Прави на ограниченията и допустимо множество."}
col_palette <- RColorBrewer::brewer.pal(3, "Set2")

y_offset <- 17

plt1 <- tribble(
  ~constr, ~x, ~y,
  "1: Бразилско кафе", 0, 120 / 0.25,
  "1: Бразилско кафе", 120 / 0.5, 0,
  "2: Кубинско кафе", 0, 160 / 0.75,
  "2: Кубинско кафе", 160 / 0.5, 0,
  "3: Търсене Делукс", 0, 150,
  "3: Търсене Делукс", 300, 150,
) %>%
  ggplot(aes(x = x, y = y)) +
    labs(
      colour = "Ограничение",
      x = expression(paste(x[1], " Супер еспресо, кг.")),
      y = expression(paste(x[2], " Делукс, кг."))
    ) +
    scale_color_manual(values = col_palette)

plt1_fs <- plt1 +
  geom_polygon(
    data = tribble(
      ~x, ~y,
      0, 0,
      240, 0,
      200, 80,
      95, 150,
      0, 150
      ),
    fill = col_palette[1],
    alpha = 0.4
  )

plt1_fs_poly_lines <- plt1_fs + 
    geom_point(aes(color = constr)) +
    geom_abline(
      data =  tribble(
        ~constr, ~ intercept, ~slope,
        "1: Бразилско кафе", 120 / 0.25, -0.5 / 0.25,
        "2: Кубинско кафе", 160 / 0.75, -0.5 / 0.75,
        "3: Търсене Делукс", 150 / 1, 0
        ),
      aes(intercept = intercept, slope = slope, colour = constr)
    )

plot(plt1_fs_poly_lines)
```

Допустимото множество е определено от всички точки, които едновременно изпълняват
всички ограничения. На фигура \@ref(fig:feasible-set-lines) това е полигонът определен от 

1. Пресечната точка на равенствата на двете ограничения
  за неотрицателност: (0, 0)
2. Пресечната точка на равенствата на ограниченията "бразилско кафе"
  и "кубинско кафе"
3. Пресечната точка на равенствата на ограниченията "кубинско кафе" 
  и "търсене на Делукс"
4. Пресечната точка на равенствата на ограниченията "търсене на Делукс" и 
  неотрицателността на Делукс (оста $x_2$). Вече пресметнахме тази точка, 
  когато чертахме правите към ограниченията: (0, 150).

В пресечната точка на правите към "кубинско кафе"/"бразилско кафе" са изпълнени
и двете равенства едновременно. За да намерим точката трябва да решим система
от двете уравнения

$$
\begin{equation}
  \left | \begin{array}{@{}l@{}}
    0.5 x_1 + 0.25 x_2 = 120 \text{ (1: бразилско кафе)} \\
    0.5 x_1 + 0.75 x_2 = 160 \text{ (2: кубинско кафе)}
  \end{array}\right.\,.
\end{equation}
$$

Един начин да решим системата е да извадим първото уравнение от
второто уравнение. Когато го направим получаваме

$$
(0.75 - 0.25) x_2 = 160 - 120 \implies \\
0.5 x_2 = 40 \implies \\x_2 = 80
$$

Заместваме с $x_2 = 80$ в първото уравнение и получаваме

$$
0.5 x_1 + 0.25 \cdot 80 = 120 \implies
x_1 = 200.
$$

Решението на системата е (200, 80): пресечната точка на двете прави.


За да намерим координатите на пресечната точка на равенствата на
"кубинско кафе" и "търсене на Делукс" трябва да решим системата от две уравнения
принадлежащи към тези ограничения:

$$
\begin{equation}
  \left | \begin{array}{@{}l@{}}
    0.5 x_1 + 0.75 x_2 = 160 \text{ (2: кубинско кафе)} \\
    0\cdot x_1 + x_2 = 150 \text{ (3: търсене делукс)}
  \end{array}\right.\,.
\end{equation}
$$
Решението на системата можем да получим, като заместим в първото уравнение с $x_2 = 150$,
за да получим

$$
\begin{equation}
  \left | \begin{array}{@{}l@{}}
    0.5 x_1 + 0.75 \cdot 150 = 160 \implies 0.5x_1 = 160 - 112.5 \implies x_1 = 95 \\
    x_2 = 150
  \end{array}\right.\,.
\end{equation}
$$

С това намерихме координатите на пресечната точка между правите на "кубинско кафе" и 
"търсене на Делукс": (95, 150).

Така получаваме, че върховете на допустимото множество (графика \@ref(fig:feasible-set)) са (0, 0), (240, 0), (200, 80), (95, 150), (0, 150).

```{r feasible-set, fig.cap="Допустимо множество и координати на върховете."}
plt_fs_annotated <- plt1_fs_poly_lines + 
  # geom_point(data = tibble(x = 200, y = 80), aes(x = x, y = y), shape = 23, size = 3) +
  # geom_abline(
  #   intercept = c(130 / 0.25, 150 / 0.25, 160 / 0.25, 167 / 0.25),
  #   slope = -0.5 / 0.25,
  #   size = 1/3,
  #   linetype = 3,
  #   color = col_palette[1]
  #   )
  annotate(
    "text", x = 0, y = 0 - y_offset, label = "(0, 0)", size = 3) +
  annotate(
  "text", x = 200, y = 80 - y_offset, label = "(200, 80)", size = 3) +
  annotate("text", x = 240, y = 0 - y_offset, label = "(240, 0)", size = 3) +
  annotate("text", x = 95, y = 150 - y_offset, label = "(95, 150)", size = 3) +
#   annotate("text", x = 200, y = 80 - y_offset, label = "(200, 80)", size = 3) +
  annotate("text", x = 0, y = 150 - y_offset, label = "(0, 150)", size = 3)
#   annotate("text", x = 165, y = 150 - y_offset, label = "(165, 150)", size = 3) +
#   annotate("text", x = 0, y = 213.3333 - y_offset, label = "(0, 213.3)", size = 3) +
#   annotate("text", x = 320, y = 0 - y_offset, label = "(320, 0)", size = 3) +

plot(plt_fs_annotated)
```


```{r}
# A <- matrix(c(
#   1 / 2, 1 / 4,
#   1 / 2, 3 / 4,
#   0, 1
#   ),
#   ncol = 2,
#   byrow = TRUE
# )
# 
# b <- c(40, 50)
# r <- c(120, 160, 150)
# 
# gMOIP::plotPolytope(
#   A = A, 
#   b = r, 
#   obj = b, 
#   crit = "max", 
#   plotFeasible = TRUE,
#   labels = "coord",
#   plotFaces = TRUE,
#   plotOptimum = TRUE
#   ) +
#   labs(
#     x = expression(paste(x[1], " (Супер еспресо кг.)")),
#     y = expression(paste(x[2], " (Делукс, кг.)"))
#   )
```

### Целева функция, нормален вектор

За да определим оптималния план графично ще начертаем прави, съответстващи на 
разпипчни нива на печалба, например 

```{r}
plt1_fs +
  xlim(c(-5, 250)) +
  ylim(c(-5, 250)) +
  geom_segment(
    data = tibble(x = 0, y = 0, xend = 2 * 40, yend = 2 * 50),
    aes(x = x, y = y, xend = xend, yend = yend),
    arrow = arrow(
      length=unit(0.15,"cm"),
      ends="last",
      type = "closed")
  ) +
  geom_abline(
    intercept = c(
        5000 / 50,
        10000 / 50,
        12000 / 50
        ),
      slope = - 40 / 50,
      linetype = 2
  ) +
  annotate("text", x = 19, y = 185 - y_offset, label = "z = 10000", size = 3) +
  annotate("text", x = 19, y = 260 - y_offset, label = "z = 12000", size = 3) +
  annotate("text", x = 19, y = 120 - y_offset, label = "z = 5000", size = 3)
```

Всички комбинации $x_1$ и $x_2$, за които печалбата (целевата функция) е равна на 5000 лв.

$$
40x_1 + 50x_2 = 5000
$$

Всички комбинации $x_1$ и $x_2$, за които печалбата (целевата функция) е равна на 1000 лв.

$$
40x_1 + 50x_2 = 10000
$$

Векторът (40, 50) се нарича нормален вектор на правите на функцията на печалба и 
той е перпендикулярен на тях. Координатите на нормалния вектор се получават от 
коефициентите на целевата функция.


### Оптимален план

### Реализация в `Excel`

[Линк](https://github.com/feb-uni-sofia/linprog-2021-2022/raw/main/excel/Problem_2_coffee_blending.xlsx) към пример за реализация в Excel.

### Реализация в `R`

<!-- ```{r} -->
<!-- result <- lpSolve::lp( -->
<!--   direction = "max", ## Вид оптимизация: min/max -->
<!--   objective.in = b, ## Objective, коефициенти на целевата функция -->
<!--   const.mat = A, ## Constraints matrix, матрица с коефициенти на ограниченията -->
<!--   const.dir = "<=", ## Constraints direction, посока на неравенствата -->
<!--   const.rhs = r, ## Right hand side, дясна страна на ограниченията -->
<!--   compute.sens=TRUE -->
<!-- ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- result -->
<!-- ``` -->


<!-- ```{r} -->
<!-- result$solution -->
<!-- ``` -->

<!-- ```{r} -->
<!-- result$duals -->
<!-- ``` -->
<!-- ```{r} -->
<!-- result$duals.from -->
<!-- ``` -->

<!-- ```{r} -->
<!-- result$duals.to -->
<!-- ``` -->

<!-- ```{r} -->
<!-- result$sens.coef.from -->
<!-- ``` -->
<!-- ```{r} -->
<!-- result$sens.coef.to -->
<!-- ``` -->

<!-- ```{r} -->
<!-- A -->
<!-- ``` -->

<!-- ```{r} -->
<!-- r -->
<!-- ``` -->

<!-- ```{r} -->
<!-- showEqn(A, r) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- Solve(A[c(1, 2), ], r[c(1, 2)]) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- eqns <- c(2, 3) -->
<!-- Solve(A[eqns, ], r[eqns]) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- eqns <- c(1, 3) -->
<!-- Solve(A[eqns, ], r[eqns]) -->
<!-- ``` -->


### Дефицитност на ресурси

Кои ресурси са дефицитни в намерения оптимален план?

### Допустими граници на промяна

- В какви граници може да се променя ограничението за бразилското кафе без
да се промени характера на оптималния план (без да се променят дефицитните ресурси)?

- В какви граници може да се променя ограничението за кубинското кафе без
да се промени характера на оптималния план (без да се променят дефицитните ресурси)?

- В какви граници може да се променя ограничението за търсенето на Супер еспресо кафе без
да се промени характера на оптималния план (без да се променят дефицитните ресурси)?

### Скрити цени

- Доставчикът предлага да достави допълнителни 10 кг. кубинско кафе на цена от
20 лв./кг. Бихте ли препоръчали на заведението да приеме тази оферта?

- Съседно кафене предлага да купи 5 килограма от бразилското кафе на цена
40 лв./кг. Изгодно ли е за заведението да продаде това количество кафе?

## Планиране на производство (2)

Фирма, специализирана в производство на зимни палта се опитва да посрещне 
търсенето на нейните стоки с възможно най-малки разходи. Всеки работник, нает в началото на 
сезона работи през целия сезон, произвежда 80 палта и получава 6000 лв. заплата.
В началото на годината фирмата разполага с 30 работника.

Търсенето на палта има силни сезонни колебания и фирмата има три опции, 
за да отговори на тези  вариации:


- работниците могат да работят и по-продължително, но допълнителният труд се
  заплаща 50% по-скъпо и работниците могат да работят не повече от 20% повече
  от нормалното работно време.
- Произведени в предишния период палта могат да се складират на цена от 12 лв.
  на сезон за всяко палто.
- Фирмата може да назначава и освобождава служители на цени 500 лв. за назначаване 
  и 420 лв. за освобождаване на служите (за целия сезон).
- Фирмата няма начални запаси от готови палта


Маркетинговият отдел на предприятието оценява, че през следващите четири сезона
търсенето ще възлиза на съответно 5000, 2000, 500 и 1500 палта.

Изгответе математически модел с който да намерите оптималния план 
(в смисъл на най-ниски разходи) за тази фирма.
